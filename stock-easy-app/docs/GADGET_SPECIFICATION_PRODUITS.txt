================================================================================
SP√âCIFICATION TABLE PRODUITS - SYNCHRONISATION GADGET ‚Üí SUPABASE
================================================================================

Date: 2025-01-27
Table: public.produits (52 colonnes au total)

================================================================================
‚úÖ CHAMPS QUE GADGET DOIT REMPLIR (Depuis Shopify)
================================================================================

Lors de la synchronisation Shopify ‚Üí Supabase, Gadget DOIT uniquement modifier
ces champs :

1. IDENTIFIANTS (OBLIGATOIRES)
   - sku (TEXT, NOT NULL) : SKU du variant Shopify
   - company_id (UUID, NOT NULL) : R√©cup√©rer via get_company_by_shopify_shop_id()

2. INFORMATIONS PRODUIT (Depuis Shopify)
   - nom_produit (TEXT) : Depuis product.title ou variant.title
   - image_url (TEXT) : Depuis product.featuredImage ou variant.image
   - stock_actuel (NUMERIC) : Depuis inventoryLevel.available (somme tous emplacements)
   - prix_vente (NUMERIC) : Depuis variant.price

3. M√âTRIQUES DE VENTES (Calcul√©es automatiquement depuis sales_history)
   Note: Ces champs sont calcul√©s automatiquement par PostgreSQL √† partir de
   la table sales_history. Gadget doit alimenter sales_history, pas ces champs.
   - ventes_totales_30j (INTEGER) : Calcul√© automatiquement
   - ventes_jour_moy_30j (NUMERIC) : Calcul√© automatiquement
   - derniere_vente (TIMESTAMP) : Calcul√© automatiquement

================================================================================
üö´ CHAMPS QUE GADGET NE DOIT JAMAIS MODIFIER
================================================================================

Ces champs sont g√©r√©s par StockEasy (utilisateurs, calculs automatiques, triggers)
et ne doivent JAMAIS √™tre modifi√©s par Gadget :

PARAM√àTRES UTILISATEUR (G√©r√©s par l'interface StockEasy):
- fournisseur (TEXT)
- prix_achat (NUMERIC)
- lead_time_days (INTEGER)
- moq (INTEGER)
- moq_source (TEXT)
- stock_secu_custom_jours (INTEGER)
- multiplicateur_prevision (NUMERIC)
- statut (TEXT)

CHAMPS CALCUL√âS AUTOMATIQUEMENT (Triggers PostgreSQL):
Ces champs sont recalcul√©s automatiquement √† chaque INSERT/UPDATE par le trigger
trigger_calculate_advanced_metrics. NE JAMAIS LES MODIFIER MANUELLEMENT.

- ventes_jour_ajustees (NUMERIC)
- stock_securite (INTEGER)
- point_commande (NUMERIC)
- qte_a_commander (INTEGER)
- marge_unitaire (NUMERIC)
- investissement (NUMERIC)
- inventory_value (NUMERIC)
- autonomie_jours (INTEGER)
- stock_max (INTEGER)
- taux_rotation (NUMERIC)
- cout_stockage_total (NUMERIC)
- risque_rupture (INTEGER)
- risque_surstock (INTEGER)
- tendance_ventes (TEXT)
- variation_ventes_pct (NUMERIC)
- marge_brute (NUMERIC)
- revenu_potentiel (NUMERIC)
- priorite_commande (INTEGER)
- stock_projete (INTEGER)
- date_rupture_estimee (TIMESTAMP)
- score_performance (INTEGER)
- categorie_abc (TEXT)
- notes_alertes (TEXT)
- health_status (TEXT)
- health_percentage (INTEGER)

M√âTADONN√âES SYST√àME:
- created_at (TIMESTAMP) : G√©r√© par PostgreSQL DEFAULT NOW()
- updated_at (TIMESTAMP) : G√©r√© automatiquement par trigger
- derniere_commande (TIMESTAMP) : G√©r√© par le syst√®me de commandes
- commandes_en_cours (INTEGER) : G√©r√© par le syst√®me de commandes
- qte_en_transit (INTEGER) : G√©r√© par le syst√®me de commandes

PARAM√àTRES SYST√àME:
- coefficient_saisonnalite (NUMERIC)
- cout_stockage_unitaire (NUMERIC)
- fiabilite_fournisseur (INTEGER)

================================================================================
üìù EXEMPLE DE CODE SQL POUR GADGET
================================================================================

Voici le pattern UPSERT s√©curis√© que Gadget doit utiliser :

INSERT INTO public.produits (
  sku,
  company_id,
  nom_produit,
  image_url,
  stock_actuel,
  prix_vente
)
VALUES (
  :shopify_sku,              -- SKU du variant Shopify
  :company_id,                -- UUID r√©cup√©r√© via get_company_by_shopify_shop_id()
  :product_title,            -- product.title ou variant.title
  :image_url,                -- product.featuredImage ou variant.image
  :inventory_available,      -- Somme de inventoryLevel.available sur tous emplacements
  :variant_price             -- variant.price
)
ON CONFLICT (sku, company_id) 
DO UPDATE SET
  nom_produit = EXCLUDED.nom_produit,
  image_url = EXCLUDED.image_url,
  stock_actuel = EXCLUDED.stock_actuel,
  prix_vente = EXCLUDED.prix_vente
  -- updated_at sera mis √† jour automatiquement par le trigger

IMPORTANT: Ne PAS inclure dans le DO UPDATE SET:
- fournisseur
- prix_achat
- lead_time_days
- moq
- Tous les champs calcul√©s (stock_securite, point_commande, etc.)
- created_at, updated_at (g√©r√©s automatiquement)

================================================================================
üîÑ FLUX DE SYNCHRONISATION
================================================================================

1. INSTALLATION INITIALE:
   a. Cr√©er company via create_shopify_company(shopify_shop_id)
   b. Synchroniser produits Shopify ‚Üí produits (UPSERT avec champs autoris√©s uniquement)
   c. Cr√©er mappings via upsert_product_mapping(company_id, shopify_variant_id, stockeasy_sku)
   d. Synchroniser historique commandes ‚Üí sales_history

2. WEBHOOKS CONTINUS:
   
   a. products/create ou products/update:
      - UPSERT dans produits (uniquement: sku, company_id, nom_produit, image_url, stock_actuel, prix_vente)
      - Cr√©er/mettre √† jour mapping si n√©cessaire
   
   b. inventory_levels/update:
      - UPDATE uniquement stock_actuel WHERE sku = :sku AND company_id = :company_id
   
   c. orders/create:
      - Ins√©rer dans sales_history (pas dans produits directement)
      - Les m√©triques ventes_totales_30j, ventes_jour_moy_30j seront recalcul√©es automatiquement

================================================================================
‚ö†Ô∏è R√àGLES CRITIQUES
================================================================================

1. GADGET NE DOIT JAMAIS:
   - Modifier les champs calcul√©s automatiquement
   - Modifier les param√®tres utilisateur (fournisseur, prix_achat, etc.)
   - √âcraser les valeurs existantes des champs utilisateur lors d'une synchronisation
   - Modifier created_at ou updated_at manuellement

2. GADGET DOIT:
   - Utiliser UPSERT avec ON CONFLICT pour √©viter les doublons
   - Respecter le mapping via product_mapping (shopify_variant_id ‚Üí stockeasy_sku)
   - Alimenter sales_history pour les ventes (pas directement les champs produits)
   - Laisser PostgreSQL calculer automatiquement tous les champs calcul√©s

3. MAPPING PRODUITS:
   - Utiliser la table product_mapping pour mapper shopify_variant_id ‚Üí stockeasy_sku
   - Cr√©er le mapping via upsert_product_mapping() si n√©cessaire
   - Utiliser shopify_variant_id (PAS lineItem.id qui change √† chaque commande)

================================================================================
üìä R√âSUM√â RAPIDE
================================================================================

GADGET PEUT MODIFIER:
‚úì sku, company_id
‚úì nom_produit, image_url
‚úì stock_actuel, prix_vente

GADGET NE DOIT PAS MODIFIER:
‚úó fournisseur, prix_achat, lead_time_days, moq
‚úó Tous les champs calcul√©s (stock_securite, point_commande, qte_a_commander, etc.)
‚úó Param√®tres utilisateur
‚úó Dates syst√®me (created_at, updated_at)
‚úó M√©tadonn√©es syst√®me (commandes_en_cours, qte_en_transit, etc.)

================================================================================
FIN DE LA SP√âCIFICATION
================================================================================









